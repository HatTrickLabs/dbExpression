version: '3'

services:
  mssql:
    container_name: mssql
    build:
      context: .
      dockerfile: dockerfile-mssql
      args:
        MsSqlVersion: ${MSSQL_VERSION}
        CreateDbScriptPath: ${CREATE_DB_SCRIPT_PATH}
        CreateDbScriptFileName: ${CREATE_DB_SCRIPT_FILENAME}
        SA_PASSWORD: ${MSSQL_PWD}
    environment:
        SA_PASSWORD: ${MSSQL_PWD}
        ACCEPT_EULA: Y
    ports:
      - '${PORT}:1433'
  netcore:
    container_name: unit_test
    build:
      context: .
      dockerfile: dockerfile-dotnetcore
    environment:
      WAIT_HOSTS: mssql:1433
      WAIT_BEFORE_HOSTS: 20
      CONNECTIONSTRINGS__HATTRICK_DBEX_MSSQL_TEST: server=mssql,1433;database=MsSqlDbExTest;uid=sa;pwd=${MSSQL_PWD};
      MSSQLVERSION: ${MSSQL_VERSION}
      TEST_PROJECT_FILENAME: ${TEST_PROJECT_FILENAME}
      BUILD_CONFIGURATION: ${BUILD_CONFIGURATION}
      TEST_OUTPUT_FILE_PATH: ${TEST_OUTPUT_FILE_PATH}
      TEST_OUTPUT_FILE_NAME: ${TEST_OUTPUT_FILE_NAME}
      CODE_COVERAGE_OUTPUT_FILE_PATH: ${CODE_COVERAGE_OUTPUT_FILE_PATH}
      CODE_COVERAGE_OUTPUT_FILE_NAME: ${CODE_COVERAGE_OUTPUT_FILE_NAME}      
    volumes:
      - ./results:/results
      - ./${TEST_PROJECT_PATH}/bin/${BUILD_CONFIGURATION}/netcoreapp3.1:/src
    depends_on:
      - mssql