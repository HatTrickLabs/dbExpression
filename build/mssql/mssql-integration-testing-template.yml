parameters:
  artifactName: ''
  rootPath: ''
  buildFilesTemplatePath: ''
  buildConfiguration: ''
  targetFrameworkMoniker: ''
  mssqlVersions: []

jobs:
- ${{ each mssqlVersion in parameters.mssqlVersions }}:
  - job: Test_MSSQL_${{ mssqlVersion }}
    displayName: 'Test MSSQL ${{ mssqlVersion }}'
    steps:
    - checkout: none
    - download: current
      artifact: ${{ parameters.artifactName }}
    
    - task: PowerShell@2
      displayName: 'Create Docker Config Files'
      inputs:
        filePath: ${{ parameters.buildFilesTemplatePath }}/create-docker-config.ps1
        arguments: '-MSSQL_VERSION ${{ mssqlVersion }} -BUILD_CONFIGURATION ${{ parameters.buildConfiguration }} -TARGET_FRAMEWORK_MONIKER ${{ parameters.targetFrameworkMoniker }}'
        workingDirectory: ${{ parameters.buildFilesTemplatePath }}
    
    - task: DockerCompose@0
      displayName: 'Execute Tests'
      inputs:
        containerregistrytype: 'Container Registry'
        dockerComposeFile: ${{ parameters.rootPath }}/docker-compose.yml
        action: 'Run a Docker Compose command'
        dockerComposeCommand: 'up --abort-on-container-exit'
        currentWorkingDirectory: ${{ parameters.rootPath }}                 
      
    - task: PublishTestResults@2
      displayName: 'Publish Test Results'
      inputs:
        testResultsFormat: VSTest
        testResultsFiles: /results/mssql-${{ mssqlVersion }}.trx
        testRunTitle: 'MSSQL ${{ mssqlVersion }}'
        mergeTestResults: true
        failTaskOnFailedTests: true
      
    - publish: /results/**
      displayName: 'Publish Results to Staging Location'
      artifact: mssql-${{ mssqlVersion }}-results