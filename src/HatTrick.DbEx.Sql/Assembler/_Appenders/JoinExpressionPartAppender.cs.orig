using HatTrick.DbEx.Sql.Expression;
using System;

namespace HatTrick.DbEx.Sql.Assembler
{
<<<<<<< HEAD:src/HatTrick.DbEx.Sql/Assembler/_Appenders/JoinExpressionPartAppender.cs
    public class JoinExpressionPartAppender : PartAppender<JoinExpression>
=======
    public class JoinAppender : 
        ExpressionAppender,
        IAssemblyPartAppender<JoinExpressionSet>,
        IAssemblyPartAppender<JoinExpression>
>>>>>>> release/1.0:src/HatTrick.DbEx.Sql/Assembler/_Appenders/JoinAppender.cs
    {        
        public override void AppendPart(JoinExpression expression, ISqlStatementBuilder builder, AssemblyContext context)
        {
            builder.Appender.Indent()
                .Write(expression.JoinType.ToString())
                .Write(" JOIN ");

            if (expression.JoinToo.Object is ExpressionSet joinExpression)
            {
                builder.Appender.Write(" (").LineBreak()
                    .Indentation++;

                //append the subquery
                builder.AppendPart(joinExpression, context);

                //append the subquery alias
                builder.Appender.Indentation--.Indent().Write(") AS ")
                    .Write(context.Configuration.IdentifierDelimiter.Begin)
                    .Write((expression as IDbExpressionAliasProvider).Alias)
                    .Write(context.Configuration.IdentifierDelimiter.End)
                    .Write(" ON ");

                builder.AppendPart(expression.JoinOnExpression, context);

                return;
            }

            context.PushAppendStyle(EntityExpressionAppendStyle.Declaration);
            builder.AppendPart(expression.JoinToo, context);
            context.PopAppendStyles();

            if (expression.JoinType == JoinOperationExpressionOperator.CROSS)
                return;

            builder.Appender.Write(" ON ");
            builder.AppendPart(expression.JoinOnExpression, context);
        }
    }
}
