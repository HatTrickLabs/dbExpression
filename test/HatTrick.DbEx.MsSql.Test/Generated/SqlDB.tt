<#@ template debug="true" hostspecific="true" language="C#" #>
<#@ assembly name="Microsoft.CSharp.dll" #>
<#@ assembly name="System.Core" #>
<#@ assembly name="System.Configuration" #>
<#@ assembly name="$(SolutionDir)Bin\HTL.DbEx.dll" #>
<#@ assembly name="$(SolutionDir)Bin\HTL.DbEx.Sql.dll" #>
<#@ assembly name="$(SolutionDir)Bin\HTL.DbEx.MsSql.dll" #>

<#@ import namespace="System.Linq" #>
<#@ import namespace="System.Collections.ObjectModel" #>
<#@ import namespace="System.Configuration" #>
<#@ import namespace="System.Text.RegularExpressions" #>
<#@ import namespace="HTL.DbEx.Sql.ObjectMap" #>
<#@ import namespace="HTL.DbEx.MsSql.ObjectMap" #>
<#@ import namespace="System.Diagnostics" #>
<#@ output extension=".cs" #>

<#@ include file="..\..\..\..\Templates\TemplateManager.ttinclude" #>
<#@ include file="..\..\..\..\Templates\SqlDB\TemplateService.ttinclude" #>
<#@ include file="..\..\..\..\Templates\SqlDB\TypeCode\TypeCode.ttinclude" #>
<#@ include file="..\..\..\..\Templates\SqlDB\Data\TableData.ttinclude" #>
<#@ include file="..\..\..\..\Templates\SqlDB\Data\ViewData.ttinclude" #>
<#@ include file="..\..\..\..\Templates\SqlDB\DataServices\TableDBEntity.ttinclude" #>
<#@ include file="..\..\..\..\Templates\SqlDB\DataServices\ViewDBEntity.ttinclude" #>
<#@ include file="..\..\..\..\Templates\SqlDB\DataServices\DBEntityProvider.ttinclude" #>

<#
	/// -------------------------------  INI  ------------------------------------------ ///

	TemplateSvc.GenerationConnectionString = "server=localhost;database=MsSqlTest;Integrated Security=True;Pooling=False;";
	TemplateSvc.GeneratedCodeNamespaceRoot = "HTL.MsSql";
	TemplateSvc.DBProviderConnectionStringName = "htl.mssql.test";
	TemplateSvc.TargetDb = "mssql";

	/// -------------------------------  END INI  ------------------------------------- ///


	this.WriteLine("// template generation @ " + DateTime.Now.ToString("MM/dd/yyyy hh:mm:ss tt") + Environment.NewLine);
	string target = TemplateSvc.TargetDb == "mssql" ? "System.Data.SqlClient" : "System.Data.MySqlClient";
	ConnectionStringSettings conn = new ConnectionStringSettings(TemplateSvc.DBProviderConnectionStringName, TemplateSvc.GenerationConnectionString, target);

	Stopwatch sw = new Stopwatch();
	this.WriteLine("// template generation started at (0) milliseconds");
	sw.Start();

	SqlModel m = new MsSqlModel(conn);
	this.WriteLine("// sql model extraction completed at (" + sw.ElapsedMilliseconds + ") milliseconds");

	var manager = Manager.Create(Host, GenerationEnvironment);
	this.WriteLine("// host manager init complete at (" + sw.ElapsedMilliseconds + ") milliseconds");

	manager.StartNewFile("TypeCode.generated.cs");
	WriteTypeCodes(m, TemplateSvc.GeneratedCodeNamespaceRoot);
	manager.EndBlock();
	this.WriteLine("// type code generation complete at (" + sw.ElapsedMilliseconds + ") milliseconds");

	manager.StartNewFile("TableData.generated.cs");
	WriteTableDataPackages(m, TemplateSvc.GeneratedCodeNamespaceRoot);
	manager.EndBlock();
	this.WriteLine("// table data package generation complete at (" + sw.ElapsedMilliseconds + ") milliseconds");

	manager.StartNewFile("ViewData.generated.cs");
	WriteViewDataPackages(m, TemplateSvc.GeneratedCodeNamespaceRoot);
	manager.EndBlock();
	this.WriteLine("// view data package generation complete at (" + sw.ElapsedMilliseconds + ") milliseconds");

	//manager.StartNewFile("DBExpressionFields.generated.cs");
	//WriteDBExpressionFields(m, TemplateSvc.GeneratedCodeNamespaceRoot);
	//manager.EndBlock();
	//this.WriteLine("// db expression field generation complete at (" + sw.ElapsedMilliseconds + ") milliseconds");

	manager.StartNewFile("TableDBEntity.generated.cs");
	WriteTableDBEntities(m, TemplateSvc.GeneratedCodeNamespaceRoot);
	manager.EndBlock();
	this.WriteLine("// table db entity generation complete at (" + sw.ElapsedMilliseconds + ") milliseconds");

	manager.StartNewFile("ViewDBEntity.generated.cs");
	WriteViewDBEntities(m, TemplateSvc.GeneratedCodeNamespaceRoot);
	manager.EndBlock();
	this.WriteLine("// view db entity generation complete at (" + sw.ElapsedMilliseconds + ") milliseconds");

	manager.StartNewFile("DBEntityProvider.generated.cs");
	WriteDBEntityProvider(m, TemplateSvc.GeneratedCodeNamespaceRoot);
	manager.EndBlock();
	this.WriteLine("// db entity provider generation complete at (" + sw.ElapsedMilliseconds + ") milliseconds");

	manager.Process(true);
	this.WriteLine("// pushing files to disk completed at (" + sw.ElapsedMilliseconds + ") milliseconds");

	sw.Stop();
	this.WriteLine("// total code gen time (" + sw.ElapsedMilliseconds + ") milliseconds");
	sw.Reset();
#>